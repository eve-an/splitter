version: "3"

tasks:
  db:up:
    desc: Run Postgres via Docker
    cmds:
      - docker compose up -d postgres

  db:down:
    desc: Stop and remove Postgres container
    cmds:
      - docker compose down

  docker:build:
    desc: Builds the docker image and assings latest tag
    cmds:
      - docker build -t splitter:latest .

  docker:run:
    desc: Runs the latest docker image
    cmds:
      - docker run -p 8080:8080 eveann/splitter:latest

  docker:push:
    desc: Pushes the image to registry
    cmds:
      - docker tag eveann/splitter:latest eveann/splitter:latest
      - docker push ivankloeckner/splitter:latest

  deploy:
    cmds:
      - ansible-playbook -i ansible/inventory.ini ansible/playbook.yaml --ask-vault-pass

  build:
    desc: Build the binary
    cmds:
      - go build -o bin/splitter ./cmd/server

  run:
    desc: Run the server locally
    cmds:
      - go run ./cmd/server

  clean:
    desc: Remove build artifacts
    cmds:
      - rm -rf bin

  test:
    desc: Run all tests
    cmds:
      - go test ./... -v
